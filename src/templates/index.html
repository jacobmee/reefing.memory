<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>项目时间线</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media (max-width: 640px) and (orientation: portrait) {
            body {
                transform: scale(0.5);
                transform-origin: top left;
                width: 200vw;
                height: 200vh;
                overflow-x: auto;
            }
        }
        /* 操作按钮默认隐藏，仅在父区域 hover 时显示 */
        .action-btn, .header-action-btn, .footer-action-btn, #add-node-button {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .timeline-item:hover .action-btn,
        .action-btn:hover {
            opacity: 1;
            pointer-events: auto;
        }
        /* header-action-btn: show when header-content's parent hovered or button hovered */
        .container:hover > .header-action-btn,
        .header-action-btn:hover {
            opacity: 1;
            pointer-events: auto;
        }
        /* footer-action-btn: show when container or button hovered */
        footer .container:hover .footer-action-btn,
        .footer-action-btn:hover {
            opacity: 1;
            pointer-events: auto;
        }
        /* add-node-button: show when flex container or button hovered */
        .flex.justify-center:hover #add-node-button,
        #add-node-button:hover {
            opacity: 1;
            pointer-events: auto;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* 时间线样式 */
        .timeline {
            position: relative;
        }
        .timeline-item {
            position: relative;
            padding: 1rem 0;
            width: 50%;
        }
        .timeline-item:nth-child(even) {
            margin-left: 50%;
            padding-left: 5.5rem; /* 增大内容和图片的间距 */
            text-align: left;
            /* 向左移动10% */
            transform: translateX(10%);
        }
        .timeline-item:nth-child(odd) {
            margin-right: 50%;
            padding-right: 5.5rem; /* 增大内容和图片的间距 */
            text-align: right;
            /* 向右移动10% */
            transform: translateX(-10%);
        }
        .timeline-dot {
            position: absolute;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 4px solid;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .timeline-item:nth-child(odd) .timeline-dot {
            right: 20px;
            /* 文字在右，整体右移30% */
            transform: translateY(-50%) translateX(30%);
        }
        .timeline-item:nth-child(odd) .bg-white {
            margin-right: 70px;
        }
        .timeline-item:nth-child(even) .timeline-dot {
            left: 20px;
            /* 文字在左，整体左移30% */
            transform: translateY(-50%) translateX(-30%);
        }
        .timeline-item:nth-child(even) .bg-white {
            margin-left: 70px;
        }
        .timeline-item:nth-child(odd) .timeline-dot {
            right: 20px;
            /* 文字在右，整体右移70% */
            transform: translateY(-50%) translateX(30%);
        }
        .timeline-item:nth-child(even) .timeline-dot {
            left: 20px;
            /* 文字在左，整体左移70% */
            transform: translateY(-50%) translateX(-30%);
        }
        .timeline-divider {
            height: 4px;
            width: 100%;
            margin: 0.5rem 0;
        }
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 50;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal.active {
            display: flex;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header Section -->
    <header class="bg-gray-800 text-white p-6 md:p-8 rounded-b-lg shadow-xl">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center">
            <div id="header-content" class="text-center md:text-left">
                <h1 id="main-title" class="text-3xl md:text-4xl lg:text-5xl font-extrabold tracking-tight mb-2">THE LOVE STORY</h1>
                <p id="subtitle" class="text-lg md:text-xl text-gray-300">A Journey Through Time for you or what you love</p>
            </div>
            <button onclick="openHeaderModal()" class="header-action-btn mt-4 md:mt-0 px-6 py-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition-colors shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.389-8.379-2.83-2.828z" />
                </svg>
            </button>
        </div>
    </header>

    <!-- Main Content Section -->
    <main class="container mx-auto px-4 py-8">
        <div class="flex justify-center mb-8">
            <button id="add-node-button" onclick="openAddModal()" class="header-action-btn flex items-center justify-center w-14 h-14 bg-green-600 text-white rounded-full hover:bg-green-700 transition-colors shadow-lg text-3xl">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>
        <div id="timeline-container" class="timeline relative max-w-4xl mx-auto mt-12">
            <!-- Timeline items will be rendered here by JavaScript -->
        </div>
    </main>

    <!-- Footer Section -->
    <footer class="bg-gray-800 text-white p-4 text-center rounded-t-lg mt-8 shadow-xl">
        <div class="container mx-auto flex items-center justify-center gap-2">
            <p id="footer-text" class="text-sm mb-0">© 2024 The Love Company. All rights reserved.</p>
            <button onclick="openFooterModal()" class="footer-action-btn px-4 py-1 text-xs bg-blue-600 text-white rounded-full hover:bg-blue-700 transition-colors shadow-md ml-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.389-8.379-2.83-2.828z" />
                </svg>
            </button>
        </div>
    </footer>

    <!-- Modals for editing -->

    <!-- Modal for adding/editing a timeline node -->
    <div id="node-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md">
            <h2 id="modal-title" class="text-2xl font-bold mb-4">增加新节点</h2>
            <form id="node-form" class="space-y-4">
                <div>
                    <label for="nodeName" class="block text-sm font-medium text-gray-700">节点名 (如: Week 1)</label>
                    <input type="text" id="nodeName" name="nodeName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                </div>
                <div>
                    <label for="title" class="block text-sm font-medium text-gray-700">标题 (如: Initial Consult)</label>
                    <input type="text" id="title" name="title" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                </div>
                <div>
                    <label for="content" class="block text-sm font-medium text-gray-700">内容 (不超过50字)</label>
                    <textarea id="content" name="content" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" maxlength="50" required></textarea>
                </div>
                <div>
                    <label for="color" class="block text-sm font-medium text-gray-700">颜色</label>
                    <input type="color" id="color" name="color" value="#10b981" class="mt-1 block w-full h-10 rounded-md border-gray-300 shadow-sm p-1">
                </div>
                <div>
                    <label for="imageUpload" class="block text-sm font-medium text-gray-700">图片 (100x100 裁剪)</label>
                    <input type="file" id="imageUpload" name="imageUpload" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">取消</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for editing header -->
    <div id="header-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">修改头部</h2>
            <form id="header-form" class="space-y-4">
                <div>
                    <label for="modal-main-title" class="block text-sm font-medium text-gray-700">主标题</label>
                    <input type="text" id="modal-main-title" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
                <div>
                    <label for="modal-subtitle" class="block text-sm font-medium text-gray-700">副标题</label>
                    <input type="text" id="modal-subtitle" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">取消</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for editing footer -->
    <div id="footer-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">修改页脚</h2>
            <form id="footer-form" class="space-y-4">
                <div>
                    <label for="modal-footer-text" class="block text-sm font-medium text-gray-700">页脚文本</label>
                    <input type="text" id="modal-footer-text" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">取消</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">保存</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 动态加载header/footer内容
        async function fetchAndRenderHeaderFooter() {
            try {
                const response = await fetch('/api/header_footer');
                if (!response.ok) return;
                const data = await response.json();
                if (data.header) {
                    document.getElementById('main-title').textContent = data.header.main_title || '';
                    document.getElementById('subtitle').textContent = data.header.subtitle || '';
                }
                if (data.footer) {
                    document.getElementById('footer-text').textContent = data.footer.footer_text || '';
                }
            } catch (e) { /* ignore */ }
        }
        const API_URL = 'http://192.168.0.28:5003/api/timeline';
        let editingNodeId = null;

        // Fetch and render timeline nodes
        async function fetchAndRenderNodes() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const nodes = await response.json();
                renderTimeline(nodes);
            } catch (error) {
                console.error("Failed to fetch timeline nodes:", error);
                renderTimeline([]); // 不显示任何节点
            }
        }

        // Render the timeline UI
        function renderTimeline(nodes) {
            const container = document.getElementById('timeline-container');
            container.innerHTML = '';
            nodes = nodes.slice().reverse();
            nodes.forEach((node, index) => {
                const isEven = index % 2 === 1;
                const alignmentClass = 'timeline-item';
                // For even (left) items, place action buttons at top right; for odd (right), at top left
                const actionBtnDiv = isEven
                  ? `<div class="absolute top-2 right-2 flex space-x-2">
                        <button onclick="openEditModal('${node.id}')" class="action-btn rounded-full bg-blue-500 hover:bg-blue-600 text-white shadow-md p-2 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-300" title="编辑">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.389-8.379-2.83-2.828z" />
                            </svg>
                        </button>
                        <button onclick="deleteNode('${node.id}')" class="action-btn rounded-full bg-red-500 hover:bg-red-600 text-white shadow-md p-2 transition-colors focus:outline-none focus:ring-2 focus:ring-red-300" title="删除">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>`
                  : `<div class="absolute top-2 left-2 flex space-x-2">
                        <button onclick="openEditModal('${node.id}')" class="action-btn rounded-full bg-blue-500 hover:bg-blue-600 text-white shadow-md p-2 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-300" title="编辑">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.389-8.379-2.83-2.828z" />
                            </svg>
                        </button>
                        <button onclick="deleteNode('${node.id}')" class="action-btn rounded-full bg-red-500 hover:bg-red-600 text-white shadow-md p-2 transition-colors focus:outline-none focus:ring-2 focus:ring-red-300" title="删除">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>`;
                const html = `
                    <div class="${alignmentClass} flex items-center mb-10">
                        <div class="relative w-full">
                            <div class="bg-white rounded-lg p-6 shadow-lg ${isEven ? 'ml-auto' : ''}">
                                <div class="mb-2">
                                    <h3 class="font-extrabold text-2xl text-gray-900 leading-tight">${node.nodeName}</h3>
                                    <h4 class="font-semibold text-lg text-gray-800 mt-1" style="margin-left:0;">${node.title}</h4>
                                </div>
                                <div class="timeline-divider" style="background-color: ${node.color};"></div>
                                <p class="mt-2 text-gray-600 text-left">${node.content}</p>
                                ${actionBtnDiv}
                            </div>
                        </div>
                        <div class="timeline-dot" style="border-color: ${node.color};">
                            <img src="${node.image}" alt="Node Icon" style="width:140px;height:140px;object-fit:cover;border-radius:9999px;">
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        // --- CRUD Operations ---

        // Add a new node
        async function addNode(nodeData) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(nodeData)
                });
                if (!response.ok) {
                    throw new Error('Failed to add node');
                }
                await fetchAndRenderNodes();
            } catch (error) {
                console.error("Error adding node:", error);
            }
        }

        // Update a node
        async function updateNode(nodeId, nodeData) {
            try {
                const response = await fetch(`${API_URL}/${nodeId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(nodeData)
                });
                if (!response.ok) {
                    throw new Error('Failed to update node');
                }
                await fetchAndRenderNodes();
            } catch (error) {
                console.error("Error updating node:", error);
            }
        }

        // Delete a node
        async function deleteNode(nodeId) {
            if (!confirm('你确定要删除这个节点吗？')) {
                return;
            }
            try {
                const response = await fetch(`${API_URL}/${nodeId}`, {
                    method: 'DELETE'
                });
                if (!response.ok) {
                    throw new Error('Failed to delete node');
                }
                await fetchAndRenderNodes();
            } catch (error) {
                console.error("Error deleting node:", error);
            }
        }

        // --- Modal Handling ---

        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => modal.classList.remove('active'));
            editingNodeId = null;
        }

        function openAddModal() {
            const modal = document.getElementById('node-modal');
            document.getElementById('modal-title').textContent = '增加新节点';
            document.getElementById('node-form').reset();
            editingNodeId = null;
            modal.classList.add('active');
        }

        async function openEditModal(nodeId) {
            const modal = document.getElementById('node-modal');
            const node = await getNodeData(nodeId);
            if (!node) {
                alert('该节点为示例数据，无法编辑。请先添加自己的节点。');
                return;
            }

            document.getElementById('modal-title').textContent = '修改节点';
            document.getElementById('nodeName').value = node.nodeName;
            document.getElementById('title').value = node.title;
            document.getElementById('content').value = node.content;
            document.getElementById('color').value = node.color;
            editingNodeId = nodeId;

            modal.classList.add('active');
        }

        async function getNodeData(nodeId) {
            try {
                const response = await fetch(`${API_URL}/${nodeId}`);
                if (!response.ok) {
                    throw new Error('Node data not found');
                }
                return await response.json();
            } catch (error) {
                console.error(error);
                return null;
            }
        }

        function openHeaderModal() {
            const modal = document.getElementById('header-modal');
            document.getElementById('modal-main-title').value = document.getElementById('main-title').textContent;
            document.getElementById('modal-subtitle').value = document.getElementById('subtitle').textContent;
            modal.classList.add('active');
        }

        function openFooterModal() {
            const modal = document.getElementById('footer-modal');
            document.getElementById('modal-footer-text').value = document.getElementById('footer-text').textContent;
            modal.classList.add('active');
        }
        
        // --- Image Cropping and Handling ---

        function cropImageAndGetBase64(file, callback) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const size = 200; // 提高分辨率
                    let sourceX = 0;
                    let sourceY = 0;
                    let sourceWidth = img.width;
                    let sourceHeight = img.height;

                    if (img.width > img.height) {
                        sourceWidth = img.height;
                        sourceX = (img.width - img.height) / 2;
                    } else {
                        sourceHeight = img.width;
                        sourceY = (img.height - img.width) / 2;
                    }

                    canvas.width = size;
                    canvas.height = size;

                    ctx.drawImage(img, sourceX, sourceY, sourceWidth, sourceHeight, 0, 0, size, size);
                    callback(canvas.toDataURL('image/png'));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // --- Event Listeners ---

        // Handle form submission for adding/editing nodes
        document.getElementById('node-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const nodeData = {
                nodeName: formData.get('nodeName'),
                title: formData.get('title'),
                content: formData.get('content'),
                color: formData.get('color'),
                image: "https://placehold.co/100x100" // Default image placeholder
            };

            const imageFile = formData.get('imageUpload');
            if (imageFile && imageFile.size > 0) {
                cropImageAndGetBase64(imageFile, async (base64Image) => {
                    nodeData.image = base64Image;
                    if (editingNodeId) {
                        await updateNode(editingNodeId, nodeData);
                    } else {
                        await addNode(nodeData);
                    }
                    closeModal();
                });
            } else {
                if (editingNodeId) {
                    // If no new image, try to keep the existing one
                    const existingNode = await getNodeData(editingNodeId);
                    if (existingNode) {
                         nodeData.image = existingNode.image;
                    }
                    await updateNode(editingNodeId, nodeData);
                } else {
                    await addNode(nodeData);
                }
                closeModal();
            }
        });

        // Handle form submission for editing header
        document.getElementById('header-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const mainTitle = document.getElementById('modal-main-title').value;
            const subtitle = document.getElementById('modal-subtitle').value;
            try {
                await fetch('/api/header_footer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        header: { main_title: mainTitle, subtitle: subtitle }
                    })
                });
                await fetchAndRenderHeaderFooter();
            } catch (err) { /* ignore */ }
            closeModal();
        });

        // Handle form submission for editing footer
        document.getElementById('footer-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const footerText = document.getElementById('modal-footer-text').value;
            try {
                await fetch('/api/header_footer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        footer: { footer_text: footerText }
                    })
                });
                await fetchAndRenderHeaderFooter();
            } catch (err) { /* ignore */ }
            closeModal();
        });
        
        // Initial fetch on page load
        document.addEventListener('DOMContentLoaded', () => {
            fetchAndRenderHeaderFooter();
            fetchAndRenderNodes();
        });
    </script>

</body>
</html>