<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <!-- Cropper.js CSS -->
    <link href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.css" rel="stylesheet" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>故事线</title>
    <!-- Include Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 媒体查询：当屏幕宽度小于640px时应用缩放 */
        :root {
            --mobile-scale: 0.4;
        }

        @media (max-width: 640px) {
            body {
                /* 使用 CSS 变量控制缩放比例 */
                transform: scale(var(--mobile-scale));
                transform-origin: top left;
                width: calc(250vw);
                height: 20vh;
                overflow-x: auto;
            }

            #node-modal.modal.active {
                align-items: flex-start !important;
                justify-content: center !important;
                padding: 10 !important;
                /* 让背景遮罩全屏且同步缩放，宽高都除以scale=0.4，即250vw/250vh */
                left: 0 !important;
                top: 0 !important;
                width: 250vw !important;
                height: 250vh !important;
                min-width: 0 !important;
                min-height: 0 !important;
                max-width: 250vw !important;
                max-height: 250vh !important;
                position: fixed !important;
                background: rgba(0, 0, 0, 0.5) !important;
                z-index: 50 !important;
            }

            #header-modal.modal.active,
            #footer-modal.modal.active {
                align-items: flex-start !important;
                justify-content: center !important;
                padding: 10 !important;
                left: 0 !important;
                top: 0 !important;
                width: 250vw !important;
                height: 250vh !important;
                min-width: 0 !important;
                min-height: 0 !important;
                max-width: 250vw !important;
                max-height: 250vh !important;
                position: fixed !important;
                background: rgba(0, 0, 0, 0.5) !important;
                z-index: 50 !important;
            }
        }

        /* 裁剪弹窗样式 */
        #cropper-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        #cropper-modal.active {
            display: flex;
        }

        #cropper-modal-content {
            background: #fff;
            border-radius: 12px;
            padding: 24px 18px 18px 18px;
            min-width: 320px;
            max-width: 95vw;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.18);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #cropper-image {
            max-width: 320px;
            max-height: 320px;
            display: block;
            margin-bottom: 18px;
            border-radius: 8px;
        }

        .action-btn,
        .header-action-btn,
        .footer-action-btn,
        #add-node-button {
            opacity: 0;
            transition: opacity 0.2s;
        }

        .action-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .action-btn:hover {
            opacity: 1;
            pointer-events: auto;
        }

        /* Header action button visibility only on button hover */
        .header-action-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .header-action-btn:hover {
            opacity: 1;
            pointer-events: auto;
        }

        /* Footer action button visibility only on button hover */
        .footer-action-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .footer-action-btn:hover {
            opacity: 1;
            pointer-events: auto;
        }

        /* Add node button visibility only on button hover */
        #add-node-button {
            opacity: 0;
            transition: opacity 0.2s;
        }
        #add-node-button:hover {
            opacity: 1;
            pointer-events: auto;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #fff;
        }

        /* Header font size smaller */
        #main-title {
            font-size: 3rem !important;
            color: #111 !important;
        }

        #subtitle {
            font-size: 1rem !important;
            color: #222 !important;
        }

        #footer-text {
            color: #222 !important;
        }

        /* Storyline styles */
        .storyline {
            position: relative;
            overflow: visible !important;
        }

        .storyline-item {
            position: relative;
            width: 50%;
            z-index: 2;
            /* Ensure storyline items are above the connector lines */
        }

        .storyline-dot {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            z-index: 10;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 2px solid;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .storyline-divider {
            height: 2px;
            width: 100%;
            margin: 0.5rem 0;
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 50;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        /* Custom confirmation modal styles */
        #confirm-modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 50;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        #confirm-modal.active {
            display: flex;
        }
    </style>
</head>
<!-- Cropper.js -->
<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.js"></script>

<body class="bg-white text-black">

    <!-- 裁剪图片弹窗 -->
    <div id="cropper-modal">
        <div id="cropper-modal-content">
            <img id="cropper-image" src="" alt="裁剪图片" />
            <div class="flex gap-4 mt-2">
                <button id="cropper-cancel"
                    class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">取消</button>
                <button id="cropper-confirm"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">确定</button>
            </div>
        </div>
    </div>

    <!-- Header Section -->
    <header class="bg-white text-black p-6 md:p-8">
        <div class="container mx-auto flex flex-row items-center justify-between w-full">
            <div id="header-content" class="text-center flex-1">
                <h1 id="main-title" class="text-5xl md:text-6xl lg:text-7xl font-extrabold tracking-tight mb-2">THE LOVE
                    STORY</h1>
                <p id="subtitle" class="text-lg md:text-xl text-gray-300">A Journey Through Time for you or what you
                    love</p>
            </div>
            <button onclick="openHeaderModal()"
                class="header-action-btn ml-4 px-6 py-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition-colors shadow-md self-start">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path
                        d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.389-8.379-2.83-2.828z" />
                </svg>
            </button>
        </div>
    </header>

    <!-- Main Content Section -->
    <main class="container mx-auto px-4 py-8" style="margin-top:50px;margin-bottom:100px;">
        <div id="storyline-row" style="display:flex;flex-direction:row;align-items:flex-end;justify-content:flex-start;">
            <div id="storyline-container" class="storyline relative max-w-4xl mx-auto" style="flex:1;display:flex;"></div>
            <button id="add-node-button" onclick="openAddModal()"
                class="header-action-btn flex items-center justify-center w-14 h-14 bg-green-600 text-white rounded-full hover:bg-green-700 transition-colors shadow-lg text-3xl" style="margin-left:12px;align-self:flex-end;">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd"
                        d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z"
                        clip-rule="evenodd" />
                </svg>
            </button>
        </div>
    </main>

    <!-- Footer Section -->
    <footer class="bg-white text-black p-4 text-center mt-8">
        <div class="container mx-auto flex items-center justify-center gap-2">
            <p id="footer-text" class="text-sm mb-0">© 2024 The Love Company. All rights reserved.</p>
            <button onclick="openFooterModal()"
                class="footer-action-btn px-4 py-1 text-xs bg-blue-600 text-white rounded-full hover:bg-blue-700 transition-colors shadow-md ml-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path
                        d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.389-8.379-2.83-2.828z" />
                </svg>
            </button>
        </div>
    </footer>

    <!-- Modals for editing -->

    <!-- Modal for adding/editing a storyline node -->
    <div id="node-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md">
            <h2 id="modal-title" class="text-2xl font-bold mb-4">增加新节点</h2>
            <form id="node-form" class="space-y-4">
                <div>
                    <label for="title" class="block text-sm font-medium text-gray-700">标题 (如: 小鸟菠菠)</label>
                    <input type="text" id="title" name="title"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                </div>
                <div>
                    <label for="content" class="block text-sm font-medium text-gray-700">内容 (不超过20字)</label>
                    <textarea id="content" name="content" rows="3"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" maxlength="20"
                        required></textarea>
                </div>
                <div>
                    <label for="color" class="block text-sm font-medium text-gray-700">颜色</label>
                    <input type="color" id="color" name="color" value="#10b981"
                        class="mt-1 block w-full h-10 rounded-md border-gray-300 shadow-sm p-1">
                </div>
                <div>
                    <label for="imageUpload" class="block text-sm font-medium text-gray-700">图片 (100x100 裁剪)</label>
                    <input type="file" id="imageUpload" name="imageUpload" accept="image/*"
                        class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="closeModal('node-modal')"
                        class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">取消</button>
                    <button type="submit"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for editing header -->
    <div id="header-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">修改头部</h2>
            <form id="header-form" class="space-y-4">
                <div>
                    <label for="modal-main-title" class="block text-sm font-medium text-gray-700">主标题</label>
                    <input type="text" id="modal-main-title"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
                <div>
                    <label for="modal-subtitle" class="block text-sm font-medium text-gray-700">副标题</label>
                    <input type="text" id="modal-subtitle"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="closeModal('header-modal')"
                        class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">取消</button>
                    <button type="submit"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for editing footer -->
    <div id="footer-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">修改页脚</h2>
            <form id="footer-form" class="space-y-4">
                <div>
                    <label for="modal-footer-text" class="block text-sm font-medium text-gray-700">页脚文本</label>
                    <input type="text" id="modal-footer-text"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="closeModal('footer-modal')"
                        class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">取消</button>
                    <button type="submit"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="confirm-modal" class="modal">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 id="confirm-title" class="text-xl font-bold mb-4">确认</h2>
            <p id="confirm-message" class="mb-6 text-gray-700">你确定要执行此操作吗？</p>
            <div class="flex justify-end space-x-2">
                <button type="button" id="confirm-cancel"
                    class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">取消</button>
                <button type="button" id="confirm-ok"
                    class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">确定</button>
            </div>
        </div>
    </div>

    <script>
        // 全局移动端缩放参数，便于统一维护
        const MOBILE_SCALE = 0.4;
        // Custom modal replacement for alert() and confirm()
        function showCustomConfirm(message, title = '确认操作') {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirm-modal');
                const titleEl = document.getElementById('confirm-title');
                const messageEl = document.getElementById('confirm-message');
                const okBtn = document.getElementById('confirm-ok');
                const cancelBtn = document.getElementById('confirm-cancel');

                titleEl.textContent = title;
                messageEl.textContent = message;
                modal.classList.add('active');

                const onOk = () => {
                    modal.classList.remove('active');
                    okBtn.removeEventListener('click', onOk);
                    cancelBtn.removeEventListener('click', onCancel);
                    resolve(true);
                };
                const onCancel = () => {
                    modal.classList.remove('active');
                    okBtn.removeEventListener('click', onOk);
                    cancelBtn.removeEventListener('click', onCancel);
                    resolve(false);
                };

                okBtn.addEventListener('click', onOk);
                cancelBtn.addEventListener('click', onCancel);
            });
        }

        // Global variable to store node data
        let nodesData = [];

        // Define an array of 7 darker colors
        const macaronColors = [
            "#B3E0F2", // Powder Blue
            "#F9D3E6", // Pale Pink
            "#C4E8D0", // Mint Green
            "#F9EBAD", // Creamy Yellow
            "#DED0F2", // Lavender
            "#F0B3B3", // Coral Pink
            "#B3D9FF"  // Sky Blue
        ];

        const API_URL = 'api/summary';
        let editingNodeId = null;

        // Fetch and render timeline nodes
        async function fetchAndRenderNodes() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                let data = await response.json();
                // 如果不是数组，尝试转换并按 order 排序
                if (!Array.isArray(data)) {
                    if (data && typeof data === 'object') {
                        data = Object.values(data);
                    } else {
                        data = [];
                    }
                }
                // 按 order 排序（无 order 的放最后）
                data = data.sort((a, b) => {
                    const ao = (a.order !== undefined) ? a.order : 99999;
                    const bo = (b.order !== undefined) ? b.order : 99999;
                    return ao - bo;
                });
                nodesData = data;
                renderSummary(nodesData);
            } catch (error) {
                console.error("Failed to fetch storyline nodes:", error);
                renderSummary([]); // Do not display any nodes
            }
        }

        function renderSummary(nodes) {
            const container = document.getElementById('storyline-container');
            const svgElement = document.getElementById('storyline-connector-svg');
            const centerLine = document.querySelector('.storyline-center-line');
            container.innerHTML = '';
            if (centerLine) container.appendChild(centerLine);
            if (svgElement) container.appendChild(svgElement);

            // 横向平铺，圆圈在上，标题和内容在下
            container.style.display = 'flex';
            container.style.flexDirection = 'row';
            container.style.justifyContent = 'flex-start';
            container.style.alignItems = 'flex-end';
            nodes.forEach((node, index) => {
                console.info(`Rendering node ${index}:`, node);
                let imgSrc = node.avatar_image || node.original_image || node.image || 'https://placehold.co/100x100';
                const html = `
                    <div class="storyline-item" style="display:flex;flex-direction:column;align-items:center;margin:0 0px;position:relative;" draggable="true" data-index="${index}" data-id="${node.id}">
                        <div style="position:absolute;top:-45px;left:50%;transform:translateX(-50%);z-index:20;display:flex;gap:8px;">
                            <button onclick="openEditModal('${node.id}')" class="action-btn rounded-full bg-blue-500 hover:bg-blue-600 text-white shadow-md p-2 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-300" title="编辑" style="box-shadow:0 2px 8px #2563eb;z-index:21;">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.389-8.379-2.83-2.828z" />
                                </svg>
                            </button>
                            <button onclick="deleteNode('${node.id}')" class="action-btn rounded-full bg-red-500 hover:bg-red-600 text-white shadow-md p-2 transition-colors focus:outline-none focus:ring-2 focus:ring-red-300" title="删除" style="box-shadow:0 2px 8px #ef4444;z-index:21;">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                        <div class="storyline-dot" style="border-color: ${node.color};margin-bottom:30px;z-index:10;cursor:pointer;" id="dot-${node.id}" onclick="window.location.href='/story?uuid=${node.id}'">
                            <img src="${imgSrc}" alt="Node Icon" style="width:114px;height:114px;object-fit:cover;border-radius:9999px;cursor:pointer;" 
                                data-preview-src="${node.original_image || imgSrc}"
                            >
                        </div>
                        <div style="text-align:center;">
                            <span class="font-semibold text-lg text-gray-800">${node.title}</span>
                            <div class="storyline-divider" style="background-color: ${node.color};margin:8px 0;"></div>
                            <p class="mt-2 text-gray-600" style="margin:0;">${node.content}</p>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
            setupDragAndDrop(container);
        }

        // 拖拽排序实现
        function setupDragAndDrop(container) {
            let dragSrcEl = null;
            container.querySelectorAll('.storyline-item').forEach(item => {
                item.addEventListener('dragstart', function (e) {
                    dragSrcEl = this;
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', this.dataset.index);
                    this.style.opacity = '0.4';
                });
                item.addEventListener('dragend', function (e) {
                    this.style.opacity = '1';
                });
                item.addEventListener('dragover', function (e) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                });
                item.addEventListener('drop', function (e) {
                    e.stopPropagation();
                    if (dragSrcEl !== this) {
                        const from = parseInt(dragSrcEl.dataset.index);
                        const to = parseInt(this.dataset.index);
                        moveNode(from, to);
                    }
                    return false;
                });
            });
        }

        // 移动节点并保存顺序
        function moveNode(from, to) {
            if (from === to) return;
            const arr = [...nodesData];
            const moved = arr.splice(from, 1)[0];
            arr.splice(to, 0, moved);
            nodesData = arr;
            renderSummary(nodesData);
            saveNodeOrder(nodesData.map(n => n.id));
        }

        // 保存顺序到后端
        async function saveNodeOrder(order) {
            try {
                await fetch(`${API_URL}/order`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order })
                });
            } catch (e) {
                console.error('保存顺序失败', e);
            }
        }

        // --- CRUD Operations ---

        // Add a new node
        async function addNode(nodeData) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(nodeData)
                });
                if (!response.ok) {
                    throw new Error('Failed to add node');
                }
                await fetchAndRenderNodes();
            } catch (error) {
                console.error("Error adding node:", error);
            }
        }

        // Update a node
        async function updateNode(nodeId, nodeData) {
            try {
                const response = await fetch(`${API_URL}/${nodeId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(nodeData)
                });
                if (!response.ok) {
                    throw new Error('Failed to update node');
                }
                await fetchAndRenderNodes();
            } catch (error) {
                console.error("Error updating node:", error);
            }
        }

        // Delete a node
        async function deleteNode(nodeId) {
            const confirmed = await showCustomConfirm('你确定要删除这个节点吗？');
            if (!confirmed) {
                return;
            }
            try {
                const response = await fetch(`${API_URL}/${nodeId}`, {
                    method: 'DELETE'
                });
                if (!response.ok) {
                    throw new Error('Failed to delete node');
                }
                await fetchAndRenderNodes();
            } catch (error) {
                console.error("Error deleting node:", error);
            }
        }

        // Get node data for editing
        async function getNodeData(nodeId) {
            try {
                const response = await fetch(`${API_URL}/${nodeId}`);
                if (!response.ok) {
                    throw new Error('Node data not found');
                }
                return await response.json();
            } catch (error) {
                console.error(error);
                return null;
            }
        }

        // --- Modal Handling ---

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            editingNodeId = null;
        }

        function openAddModal() {
            const modal = document.getElementById('node-modal');
            document.getElementById('modal-title').textContent = '增加新节点';
            document.getElementById('node-form').reset();

            // Randomly select a darker color
            const randomColor = macaronColors[Math.floor(Math.random() * macaronColors.length)];
            document.getElementById('color').value = randomColor;

            editingNodeId = null;
            modal.classList.add('active');
        }

        async function openEditModal(nodeId) {
            const modal = document.getElementById('node-modal');
            let node = nodesData.find(n => n.id === nodeId);
            if (!node) {
                node = await getNodeData(nodeId);
            }
            if (!node) {
                await showCustomConfirm('未找到该节点数据，无法编辑。请先添加自己的节点。');
                return;
            }
            document.getElementById('modal-title').textContent = '修改节点';
            document.getElementById('title').value = node.title;
            document.getElementById('content').value = node.content;
            document.getElementById('color').value = node.color;
            editingNodeId = nodeId;
            modal.classList.add('active');
        }

        async function fetchHeaderFooterData() {
            try {
                const response = await fetch(`${API_URL}/info`);
                if (!response.ok) return { header: {}, footer: {} };
                return await response.json();
            } catch (e) {
                return { header: {}, footer: {} };
            }
        }

        async function fetchAndRenderHeaderFooter() {
            const data = await fetchHeaderFooterData();
            if (data.header) {
                document.getElementById('main-title').textContent = data.header.main_title || '';
                document.getElementById('subtitle').textContent = data.header.subtitle || '';
            }
            if (data.footer) {
                document.getElementById('footer-text').textContent = data.footer.footer_text || '';
            }
        }

        function openHeaderModal() {
            const modal = document.getElementById('header-modal');
            document.getElementById('modal-main-title').value = document.getElementById('main-title').textContent;
            document.getElementById('modal-subtitle').value = document.getElementById('subtitle').textContent;
            modal.classList.add('active');
        }

        function openFooterModal() {
            const modal = document.getElementById('footer-modal');
            document.getElementById('modal-footer-text').value = document.getElementById('footer-text').textContent;
            modal.classList.add('active');
        }

        // --- Image Cropping and Handling ---

        function cropImageAndGetBase64(file, callback) {
            // 新实现：弹出裁剪弹窗，用户拖拽后裁剪
            const reader = new FileReader();
            reader.onload = (e) => {
                const cropperModal = document.getElementById('cropper-modal');
                const cropperImg = document.getElementById('cropper-image');
                cropperImg.src = e.target.result;
                cropperModal.classList.add('active');

                let cropper = null;
                // 等图片加载后初始化 cropper
                cropperImg.onload = () => {
                    if (cropper) cropper.destroy();
                    cropper = new Cropper(cropperImg, {
                        aspectRatio: 1,
                        viewMode: 1,
                        dragMode: 'move',
                        autoCropArea: 1,
                        background: false,
                        movable: true,
                        zoomable: true,
                        rotatable: false,
                        scalable: false,
                        minCropBoxWidth: 100,
                        minCropBoxHeight: 100
                    });
                };

                // 取消按钮
                document.getElementById('cropper-cancel').onclick = () => {
                    cropperModal.classList.remove('active');
                    if (cropper) cropper.destroy();
                };
                // 确定按钮
                document.getElementById('cropper-confirm').onclick = () => {
                    // 获取裁剪区域
                    const canvas = cropper.getCroppedCanvas({ width: 200, height: 200, imageSmoothingQuality: 'high' });
                    // 生成圆形头像
                    const circleCanvas = document.createElement('canvas');
                    circleCanvas.width = 200;
                    circleCanvas.height = 200;
                    const ctx = circleCanvas.getContext('2d');
                    ctx.clearRect(0, 0, 200, 200);
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(100, 100, 100, 0, 2 * Math.PI);
                    ctx.closePath();
                    ctx.clip();
                    ctx.drawImage(canvas, 0, 0, 200, 200);
                    ctx.restore();
                    cropperModal.classList.remove('active');
                    if (cropper) cropper.destroy();
                    callback(circleCanvas.toDataURL('image/png'));
                };
            };
            reader.readAsDataURL(file);
        }

        // --- Event Listeners ---

        // Handle form submission for adding/editing nodes
        document.getElementById('node-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const nodeData = {
                title: formData.get('title'),
                content: formData.get('content'),
                color: formData.get('color')
            };

            const imageFile = formData.get('imageUpload');
            if (imageFile && imageFile.size > 0) {
                // 先读取原图 base64
                const reader = new FileReader();
                reader.onload = (e) => {
                    const originalBase64 = e.target.result;
                    // 再裁剪头像
                    cropImageAndGetBase64(imageFile, async (avatarBase64) => {
                        nodeData.original_image_base64 = originalBase64;
                        nodeData.avatar_image_base64 = avatarBase64;
                        if (editingNodeId) {
                            await updateNode(editingNodeId, nodeData);
                        } else {
                            await addNode(nodeData);
                        }
                        closeModal('node-modal');
                    });
                };
                reader.readAsDataURL(imageFile);
            } else {
                if (editingNodeId) {
                    // If no new image,不传base64，后端保留原有图片
                    await updateNode(editingNodeId, nodeData);
                } else {
                    await addNode(nodeData);
                }
                closeModal('node-modal');
            }
        });

        // Handle form submission for editing header
        document.getElementById('header-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = await fetchHeaderFooterData();
            const mainTitle = document.getElementById('modal-main-title').value;
            const subtitle = document.getElementById('modal-subtitle').value;
            const payload = {
                header: { main_title: mainTitle, subtitle: subtitle },
                footer: data.footer
            };
            try {
                await fetch(`${API_URL}/info`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                await fetchAndRenderHeaderFooter();
            } catch (err) { /* ignore */ }
            closeModal('header-modal');
        });

        // Handle form submission for editing footer
        document.getElementById('footer-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = await fetchHeaderFooterData();
            const footerText = document.getElementById('modal-footer-text').value;
            const payload = {
                header: data.header,
                footer: { footer_text: footerText }
            };
            try {
                await fetch(`${API_URL}/info`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                await fetchAndRenderHeaderFooter();
            } catch (err) { /* ignore */ }
            closeModal('footer-modal');
        });

        // Initial fetches on page load
        document.addEventListener('DOMContentLoaded', () => {
            fetchAndRenderHeaderFooter();
            fetchAndRenderNodes();
        });
    </script>

</body>
</html>